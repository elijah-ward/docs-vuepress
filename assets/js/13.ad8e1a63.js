(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{288:function(e,t,a){"use strict";a.r(t);var n=a(0),r=Object(n.a)({},function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"using-haproxy-as-a-loadbalancer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-haproxy-as-a-loadbalancer","aria-hidden":"true"}},[e._v("#")]),e._v(" Using HAProxy as a loadbalancer")]),e._v(" "),a("p",[e._v("To avoid sending traffic to unavailable nodes, HAProxy can check the health of\ntheir downstream services via http or tcp. This document explains how to create\na custom health check for Rundeck.")]),e._v(" "),a("h3",{attrs:{id:"enable-cgi-scripts-for-rundeck"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#enable-cgi-scripts-for-rundeck","aria-hidden":"true"}},[e._v("#")]),e._v(" Enable CGI Scripts for Rundeck")]),e._v(" "),a("p",[e._v("The first step is to enable the CGI Script access on the embedded Jetty\ncontainer.")]),e._v(" "),a("p",[e._v("Note: These settings are valid for the rpm/deb or launcher install.")]),e._v(" "),a("h4",{attrs:{id:"edit-the-web-xml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#edit-the-web-xml","aria-hidden":"true"}},[e._v("#")]),e._v(" Edit the web.xml")]),e._v(" "),a("p",[e._v("In the launcher, the file "),a("code",[e._v("web.xml")]),e._v(" is located on\n"),a("code",[e._v("$RDECK_BASE/server/exp/webapp/WEB-INF")])]),e._v(" "),a("p",[e._v("For deb/rpm installers, the "),a("code",[e._v("web.xml")]),e._v(" is located in "),a("code",[e._v("/var/lib/rundeck/server/exp/webapp/WEB-INF")])]),e._v(" "),a("p",[e._v('Add the following attributes before the last "security-constraint" label (the one that contains the auth-constraint attribute). This will avoid the redirect to the login page if you are not logged in Rundeck.')]),e._v(" "),a("div",{staticClass:"language-{.xml} extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("<security-constraint>\n    <web-resource-collection>\n        <web-resource-name>cgi</web-resource-name>\n        <url-pattern>/cgi-bin/*</url-pattern>\n    </web-resource-collection>\n</security-constraint>\n")])])]),a("p",[e._v("After the last servlet attribute, add the following settings. A folder called\n"),a("code",[e._v("WEB-INF/cgi-bin")]),e._v(" must be created (the name of the folder can be defined by the user)")]),e._v(" "),a("div",{staticClass:"language-{.xml} extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("<servlet>\n    <servlet-name>CGI</servlet-name>\n    <servlet-class>org.eclipse.jetty.servlets.CGI</servlet-class>\n    <init-param>\n        <param-name>Path</param-name>\n        <param-value>/bin:/usr/bin:/usr/local/bin</param-value>\n    </init-param>\n    <init-param>\n        <param-name>cgibinResourceBaseIsRelative</param-name>\n        <param-value>true</param-value>\n    </init-param>\n    <init-param>\n        <param-name>commandPrefix</param-name>\n        <param-value>/usr/bin/python</param-value>\n    </init-param>\n    <init-param>\n        <param-name>cgibinResourceBase</param-name>\n        <param-value>WEB-INF/cgi-bin</param-value>\n    </init-param>\n    <async-supported>true</async-supported>\n    <load-on-startup>1</load-on-startup>\n</servlet>\n```\n")])])]),a("p",[e._v('Add the following settings after the last "servlet-mapping" attribute. The "cgi-bin" name must match with the settings defined on the servlet.')]),e._v(" "),a("div",{staticClass:"language-{.xml} extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("<servlet-mapping>\n    <servlet-name>CGI</servlet-name>\n    <url-pattern>/cgi-bin/*</url-pattern>\n</servlet-mapping>\n")])])]),a("h4",{attrs:{id:"run-the-script"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-the-script","aria-hidden":"true"}},[e._v("#")]),e._v(" Run the Script")]),e._v(" "),a("p",[e._v("With this settings, any script added to "),a("code",[e._v("$RDECK_BASE/server/exp/webapp/WEB-INF/cgi-bin")]),e._v(",\ncan be called as an endpoint. For example, the URL: "),a("code",[e._v("http://localhost:4440/cgi-bin/somescript")]),e._v(" will call the script "),a("code",[e._v("$RDECK_BASE/server/exp/webapp/WEB-INF/cgi-bin/somescript")])]),e._v(" "),a("h3",{attrs:{id:"create-the-health-check-script-on-each-instance"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-the-health-check-script-on-each-instance","aria-hidden":"true"}},[e._v("#")]),e._v(" Create the health check script on each instance")]),e._v(" "),a("p",[e._v('The health check uses a Rundeck API to get system information. A health check could factor in other information like scheduler thread ratio, CPU load or memory utilization. For an active/standby configuration, the health check should check the execution mode. When the execution mode is set to "passive" the load balancer should route around it.')]),e._v(" "),a("p",[e._v("The example below uses a python script to demonstrate this.")]),e._v(" "),a("p",[e._v("Create the following script on "),a("code",[e._v("$RDECK_BASE/server/exp/webapp/WEB-INF/cgi-bin/status")])]),e._v(" "),a("div",{staticClass:"language-{.python} extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('#!/usr/bin/python\n\nimport sys\nimport os\nimport cgi\n\nfrom cgi import escape\nimport requests\nimport json\n\nform = cgi.FieldStorage()\ntoken = form.getvalue("token")\nexecutionMode= form.getvalue("executionMode")\n\nurl = \'http://localhost:4440/api/20/system/info?format=json&authtoken=\' + token\n\nresponse = requests.post(url)\ninfo = json.loads(response.text)\ncurrentExecutionMode = info["system"]["executions"]["executionMode"]\n\nif currentExecutionMode == executionMode:\n    status = "200"\nelse:\n    status = "403"\n\n\nprint "Content-type: text/html"\nprint \'Status:\' + status + \' \'\n\nprint\nprint "<!doctype html>"\nprint "<html>"\nprint "<body>"\n\nprint \'Current Execution Mode:\' + currentExecutionMode\nprint "<br>"\nprint \'Expected Execution Mode:\' + executionMode\nprint "</body>"\nprint "</html>"\n')])])]),a("p",[e._v("After the script has been deployed use your browser to visit the new health check page.")]),e._v(" "),a("p",[e._v('The URL accepts a parameter called "executionMode" which takes one of two values: active or passive. If specified mode matches the actual mode the page will return HTTP response code 200 otherwise it will return 403.')]),e._v(" "),a("p",[e._v("For example: "),a("code",[e._v("http://localhost:4440/cgi-bin/status?token=<token>&executionMode=active")])]),e._v(" "),a("p",[a("img",{attrs:{src:"/figures/haproxy-health-check.png",alt:"Example health check"}})]),e._v(" "),a("h3",{attrs:{id:"on-haproxy-add-the-following-settings"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#on-haproxy-add-the-following-settings","aria-hidden":"true"}},[e._v("#")]),e._v(" On HAProxy, add the following settings")]),e._v(" "),a("p",[e._v("The web load balancer serving traffic to the Rundeck instance should be configured with the health check.")]),e._v(" "),a("ul",[a("li",[e._v('Add the "httpchk" with the URI of the health check. The token value and the execution mode that you want to use are needed.')]),e._v(" "),a("li",[e._v('Add the "http-check" with the expected status (in this case 200)')])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("backend default_service\ncookie JSESSIONID prefix nocache\noption httpchk get /cgi-bin/status?token=<TOKEN_VALUE>&executionMode=active\nhttp-check expect status 200\nserver rundeck1 192.168.0.1:4440 cookie rundeck1 check inter 2000 rise 2 fall 3\nserver rundeck2 192.168.0.2:4440 cookie rundeck2 check inter 2000 rise 2 fall 3\nserver rundeck3 192.168.0.3:4440 cookie rundeck3 check inter 2000 rise 2 fall 3\n")])])]),a("h3",{attrs:{id:"check-if-haproxy-redirect-to-the-active-instance"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check-if-haproxy-redirect-to-the-active-instance","aria-hidden":"true"}},[e._v("#")]),e._v(" Check if HAProxy redirect to the active instance")]),e._v(" "),a("p",[e._v('Once the web load balancer has been configured with the health check, any instance that is not in "active" mode will not be passed traffic.')]),e._v(" "),a("p",[a("img",{attrs:{src:"/figures/haproxy-status.png",alt:"HAProxy status"}})])])},[],!1,null,null,null);t.default=r.exports}}]);