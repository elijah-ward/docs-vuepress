(window.webpackJsonp=window.webpackJsonp||[]).push([[279],{195:function(e,t,n){"use strict";n.r(t);var s=n(0),o=Object(s.a)({},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"jobs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jobs","aria-hidden":"true"}},[e._v("#")]),e._v(" Jobs")]),e._v(" "),n("p",[e._v("Jobs are a convenient method to establish a library of routine\nprocedures. By their nature, a Job encapsulates a process as a\nlogically named interface. Jobs can begin as a single step workflow\nthat calls an inline shell script but evolve into a multi-step\nworkflow, that calls specialized steps.\nA job can also call other jobs as steps in its\nworkflow. Using this approach one can view each Job as a reusable\nbuilding block upon which more complex processes can be built.")]),e._v(" "),n("p",[e._v("The administrator decides Jobs can be used to encapsulate\nthe restart procedures. Both developers and\nadministrators can collaborate on the job definitions, their evolution and\nmaintenance.")]),e._v(" "),n("h2",{attrs:{id:"job-structure"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#job-structure","aria-hidden":"true"}},[e._v("#")]),e._v(" Job structure")]),e._v(" "),n("p",[e._v("The overall goal is to provide a single restart procedure, for the sake of reusability, it\nmight be preferred to break each step of the process into separate jobs.")]),e._v(" "),n("p",[e._v("Using this approach the administrator imagines the following jobs:")]),e._v(" "),n("ul",[n("li",[e._v("start: call the start procedure to start the web service")]),e._v(" "),n("li",[e._v("stop: call the stop procedure to stop the web service")]),e._v(" "),n("li",[e._v("status: call the status procedure to stop the web service")]),e._v(" "),n("li",[e._v("Restart: call the stop, start, and status jobs")])]),e._v(" "),n("p",[e._v("Since the restart procedure is the primary focus, it is capitalized\nfor distinction.")]),e._v(" "),n("p",[e._v("The extra complexity from defining a job for every individual step can\npay off later, if those steps can be recombined with future jobs to\nserve later management needs. How far a process is decomposed into\nindividual jobs is a judgement balancing maintenance requirements\nand the desire for job reuse.")]),e._v(" "),n("h3",{attrs:{id:"job-grouping"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#job-grouping","aria-hidden":"true"}},[e._v("#")]),e._v(" Job grouping")]),e._v(" "),n("p",[e._v("It is helpful to use job groups and have a convention for naming them.\nA good convention assists others with a navigation scheme that\nhelps them remember and find the desired procedure. Job groups\nalso help simplify access control policy.")]),e._v(" "),n("p",[e._v('The administrator chooses to create a top level group named\n"web" where the web restart related jobs will be organized.')]),e._v(" "),n("pre",[n("code",[e._v("web/\n|-- Restart\n|-- start\n|-- status\n`-- stop\n")])]),e._v(" "),n("p",[e._v('When opening the "anvils" project users will see the jobs\ngrouped below web as shown in the screenshot below.')]),e._v(" "),n("p",[n("img",{attrs:{src:"/figures/fig0604.png",alt:"Anvils job group"}})]),e._v(" "),n("h2",{attrs:{id:"scripts"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#scripts","aria-hidden":"true"}},[e._v("#")]),e._v(" Scripts")]),e._v(" "),n("p",[e._v("Sets of scripts are already in use to manage the startup and shutdown\nprocedures. Rather than force the issue as to\nwhich one is correct or superior, the administrator focuses on\ncreating a skeleton to more easily present how scripts can be\nencapsulated by the job workflow. After demonstrating this simple\nframework, the administrator can discuss how to incorporate the best\nof script implementations from the ops and dev teams into the Job definitions.")]),e._v(" "),n("p",[e._v("For the skeleton, the administrator creates placeholder scripts\nthat merely echo their intent but define the essential arguments they will need.\nThe scripts - start, status and stop - represent the logical steps of\nthe restart process.")]),e._v(" "),n("p",[e._v("File listing: start")]),e._v(" "),n("div",{staticClass:"language-{.bash .numberLines} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('#!/bin/bash\n#/ usage: start ?dir?\nset -eu\n[[ $# != 1 ]] && {\n  grep \'^#/ usage:\' <"$0" | cut -c4- >&2 ; exit 2;\n}\nDIR=$1\nmkdir -p "$DIR"\necho $$ > "$DIR/pid"\necho "- Web started (pid=$$)"\n')])])]),n("p",[e._v("File listing: status")]),e._v(" "),n("div",{staticClass:"language-{.bash .numberLines} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('#!/bin/bash\n#/ usage: status ?dir?\nset -eu\n[[ $# != 1 ]] && {\n  grep \'^#/ usage:\' <"$0" | cut -c4- >&2 ; exit 2;\n}\nDIR=$1\n[[ ! -f "$DIR/pid" ]] && { echo DOWN; exit 1; }\nPID=$(cat "$DIR/pid")\n[[ -z "$PID" ]] && { echo "DOWN"; exit 1; } || { echo "- RUNNING (pid=$PID)"; }\n')])])]),n("p",[e._v("File listing: stop")]),e._v(" "),n("div",{staticClass:"language-{.bash .numberLines} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('#!/bin/bash\n#/ usage: stop ?dir? ?method?\nset -eu\n[[ $# != 2 ]] && {\n  grep \'^#/ usage:\' <"$0" | cut -c4- >&2 ; exit 2;\n}\nDIR=$1\nMETHOD=$2\nif [[ -f "$DIR/pid" ]]\nthen\n  pid=$(cat "$DIR/pid")\n  rm -f "$DIR/pid"; #approximates a kill process\n  exit_code=$?\n  echo "- Web stopped (pid=${pid}) using method: $METHOD"\nfi\nexit ${exit_code:-0}\n')])])]),n("p",[e._v('Because either the normal or force can be specified for the\n"method" option, the Jobs will need to pass the user\'s choice as an\nargument to the script.')]),e._v(" "),n("p",[e._v("There is no script for the restart process itself since that will be\ndefined as a Job workflow.")]),e._v(" "),n("h2",{attrs:{id:"job-options"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#job-options","aria-hidden":"true"}},[e._v("#")]),e._v(" Job options")]),e._v(" "),n("p",[e._v('To support specifying parameters to the scripts,\nthe the three jobs will declare an option named "dir"\nto specify the web service install directory. The stop\nscript will need an additional option, "method" to specify '),n("code",[e._v("normal")]),e._v(" or "),n("code",[e._v("force")]),e._v(" choices.")]),e._v(" "),n("p",[e._v("A benefit of job options is the ability to display a\nmenu of choices to the user running the job. Once chosen, the value\nselected by the menu is then passed to the script.\nOptions can also have default values or lists of choices to help\nthe user choose between routine inputs.")]),e._v(" "),n("h3",{attrs:{id:"allowed-option-values"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#allowed-option-values","aria-hidden":"true"}},[e._v("#")]),e._v(" Allowed option values")]),e._v(" "),n("p",[e._v("An option can be defined to only allow values from a specified\nlist. This places safe guards on how a Job can be run by limiting\nchoices to those the scripts can safely handle.")]),e._v(" "),n("p",[e._v('The administrator takes advantage of this by limiting the "method" option\nvalues to just "normal" or "force" choices.')]),e._v(" "),n("p",[e._v('The screenshot below contains the Option edit form for the "method" option.\nThe form includes elements to define description and default\nvalue, as well as, Allowed Values and Restrictions.')]),e._v(" "),n("p",[n("img",{attrs:{src:"/figures/fig0605.png",alt:"Option editor for method"}})]),e._v(" "),n("p",[e._v('Allowed values can be specified as a comma separated list as seen above but\ncan also be requested from an external source using a "remote URL".')]),e._v(" "),n("p",[e._v('Option choices can be controlled using the "Enforced from values"\nrestriction. When set "true", the Rundeck UI will only present a\npopup menu. If set "false", a text field will also be presented. Use\nthe "Match Regular Expression" form to validate the input option.')]),e._v(" "),n("p",[e._v("Here's a screenshot of how Rundeck will display the menu choices:")]),e._v(" "),n("p",[n("img",{attrs:{src:"/figures/fig0606.png",alt:"Option menu for method"}})]),e._v(" "),n("h3",{attrs:{id:"script-access-to-option-data"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#script-access-to-option-data","aria-hidden":"true"}},[e._v("#")]),e._v(" Script access to option data")]),e._v(" "),n("p",[e._v('Option values can be passed to scripts as an argument or referenced\ninside the script using a named token. For example, the values for the\n"method" an "dir" options can be accessed in one of several ways:')]),e._v(" "),n("p",[e._v('Value referenced as an environment variable. Each option name is upcased\nand prefixed with "RD'),n("em",[e._v("OPTION")]),e._v('":')]),e._v(" "),n("ul",[n("li",[e._v("Bash: "),n("code",[e._v("$RD_OPTION_METHOD")]),e._v(", "),n("code",[e._v("$RD_OPTION_DIR")])])]),e._v(" "),n("p",[e._v("Value passed in the argument vector to the executed script or command\nvia the "),n("code",[e._v("scriptargs")]),e._v(" tag.")]),e._v(" "),n("ul",[n("li",[e._v("Commandline Arguments: "),n("code",[e._v("${option.method}")]),e._v(", "),n("code",[e._v("${option.dir}")])])]),e._v(" "),n("p",[e._v("Value represented as a named token inside the script and replaced\nbefore execution:")]),e._v(" "),n("ul",[n("li",[e._v("Script Content: "),n("code",[e._v("@option.method@")]),e._v(", "),n("code",[e._v("@option.dir@")])])]),e._v(" "),n("h2",{attrs:{id:"job-definition"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#job-definition","aria-hidden":"true"}},[e._v("#")]),e._v(" Job definition")]),e._v(" "),n("p",[e._v("With an understanding of the scripts and the option needed to\ncontrol the restart operation, the final step is to compose the Job\ndefinitions.")]),e._v(" "),n("p",[e._v("While each job can be defined graphically in Rundeck, each can\nsuccinctly be defined using an XML file conforming to the\n"),n("router-link",{attrs:{to:"/manpages/man5/job-v20.html"}},[e._v("job-xml")]),e._v("\ndocument format. This\ndocument contains a set of tags corresponding to the choices seen in\nthe Rundeck GUI form.")],1),e._v(" "),n("p",[e._v("Below are the XML definitions for the jobs. One or more jobs can be\ndefined inside a single XML file but your convention will dictate how to\norganize the definitions. The files can be named any way desired and\ndo not have to correspond to the Job name or its group.")]),e._v(" "),n("p",[e._v("File listing: stop.xml")]),e._v(" "),n("div",{staticClass:"language-{.xml .numberLines} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<joblist>\n    <job>\n       <name>stop</name>\n       <description>the web stop procedure</description>\n       <loglevel>INFO</loglevel>\n       <group>web</group>\n       <context>\n         <options>\n           <option name="method" enforcedvalues="true"\n                   required="true"\n               values="normal,force"/>\n           <option name="dir" enforcedvalues="false" required="true"\n             default="$HOME/anvils" />\n           </options>\n       </context>\n       <sequence threadcount="1" keepgoing="false" strategy="node-first">\n         <command>\n           <script><![CDATA[#!/bin/bash\n#/ usage: stop ?dir? ?method?\nset -eu\n[[ $# != 2 ]] && {\n  grep \'^#/ usage:\' <"$0" | cut -c4- >&2 ; exit 2;\n}\nDIR=$1\nMETHOD=$2\nif [[ -f "$DIR/pid" ]]\nthen\n        pid=$(cat "$DIR/pid")\n        rm -f "$DIR/pid"; #approximates a kill process\n        exit_code=$?\n        echo "- Web stopped (pid=${pid}) using method: $METHOD"\nfi\nexit ${exit_code:-0}]]><\/script>\n            <scriptargs>${option.method}</scriptargs>\n         </command>\n       </sequence>\n       <nodefilters excludeprecedence="true">\n         <include>\n           <tags>www</tags>\n         </include>\n       </nodefilters>\n       <dispatch>\n         <threadcount>1</threadcount>\n         <keepgoing>false</keepgoing>\n       </dispatch>\n     </job>\n</joblist>\n')])])]),n("p",[e._v('Defines Job, /web/stop, and executes the shell script to\nNodes tagged "web". Using the '),n("code",[e._v("scriptargs")]),e._v(" tag, the shell\nscript is passed a single argument, "),n("code",[e._v("${option.method}")]),e._v(",\ncontaining the value chosen in the Job run form.")]),e._v(" "),n("p",[e._v("File listing: start.xml")]),e._v(" "),n("div",{staticClass:"language-{.xml .numberLines} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<joblist>\n   <job>\n     <name>start</name>\n     <description>the web start procedure</description>\n     <loglevel>INFO</loglevel>\n     <group>web</group>\n    <context/>\n    <context>\n       <options>\n         <option name="dir" enforcedvalues="false" required="true"\n                 default="$HOME/anvils" />\n       </options>\n    </context>\n    <sequence threadcount="1" keepgoing="false" strategy="node-first">\n     <command>\n      <script><![CDATA[#!/bin/bash\n#/ usage: start ?dir?\nset -eu\n[[ $# != 1 ]] && {\n  grep \'^#/ usage:\' <"$0" | cut -c4- >&2 ; exit 2;\n}\nDIR=$1\nmkdir -p "$DIR"\necho $$ > "$DIR/pid"\necho "- Web started (pid=$$)"]]><\/script>\n     </command>\n  </sequence>\n    <nodefilters excludeprecedence="true">\n      <include>\n        <tags>www</tags>\n      </include>\n   </nodefilters>\n   <dispatch>\n     <threadcount>1</threadcount>\n     <keepgoing>false</keepgoing>\n   </dispatch>\n  </job>\n</joblist>\n')])])]),n("p",[e._v('Defines Job, /web/start, that also executes a shell script to\nNodes tagged "web".')]),e._v(" "),n("p",[e._v("File listing: status.xml")]),e._v(" "),n("div",{staticClass:"language-{.xml .numberLines} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<joblist>\n   <job>\n     <name>status</name>\n     <description>the web status procedure</description>\n     <loglevel>INFO</loglevel>\n     <group>web</group>\n     <context>\n       <options>\n         <option name="dir" enforcedvalues="false" required="true"\n                 default="$HOME/anvils" />\n       </options>\n     </context>\n     <sequence threadcount="1" keepgoing="false" strategy="node-first">\n     <command>\n      <script><![CDATA[#!/bin/bash\n#/ usage: status ?dir?\nset -eu\n[[ $# != 1 ]] && {\n  grep \'^#/ usage:\' <"$0" | cut -c4- >&2 ; exit 2;\n}\nDIR=$1\n[[ ! -f "$DIR/pid" ]] && { echo DOWN; exit 1; }\nPID=$(cat "$DIR/pid")\n[[ -z "$PID" ]] && { echo "DOWN"; exit 1; } || { echo "- RUNNING (pid=$PID)"; }\n]]><\/script>\n     </command>\n  </sequence>\n    <nodefilters excludeprecedence="true">\n      <include>\n        <tags>www</tags>\n      </include>\n   </nodefilters>\n   <dispatch>\n     <threadcount>1</threadcount>\n     <keepgoing>false</keepgoing>\n   </dispatch>\n  </job>\n</joblist>\n')])])]),n("p",[e._v('Defines Job, /web/status, that also executes a shell script to\nNodes tagged "web".')]),e._v(" "),n("blockquote",[n("p",[e._v("Note, these examples demonstrate Jobs with inline scripts. This is for the purpose of providing a simple and transparent example. You may rightly consider other approaches such as external scriptfiles or custom steps to further encapsulate the code from the job definition.")])]),e._v(" "),n("h3",{attrs:{id:"restart-job-composition"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#restart-job-composition","aria-hidden":"true"}},[e._v("#")]),e._v(" Restart Job composition")]),e._v(" "),n("p",[e._v('The final job definition declares the "Restart" job which merely\nwraps calls to the stop, start, status jobs already defined.\nThis is done by declaring a sequence of Job calls,\nusing the '),n("code",[e._v("jobref")]),e._v(' xml tag.\nRestart also must pass the "dir" and "method" options so it\ndeclares those too and uses the '),n("code",[e._v("arg")]),e._v(" xml tag to pass them.")]),e._v(" "),n("p",[e._v("File listing: restart.xml")]),e._v(" "),n("div",{staticClass:"language-{.xml .numberLines} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<joblist>\n   <job>\n     <name>Restart</name>\n     <description>restart the web server</description>\n     <loglevel>INFO</loglevel>\n     <group>web</group>\n     <context>\n       <options>\n         <option name="method" enforcedvalues="true" required="false"\n                 values="normal,force" />\n         <option name="dir" enforcedvalues="false" required="true"\n                 default="$HOME/anvils" />\n       </options>\n     </context>\n     <sequence threadcount="1" keepgoing="false" strategy="node-first">\n      <command>\n        <jobref name="stop" group="web">\n          <arg line="-dir ${option.dir} -method ${option.method}"/>\n        </jobref>\n      </command>\n      <command>\n        <jobref name="start" group="web">\n          <arg line="-dir ${option.dir}"/>\n        </jobref>\n      </command>\n      <command>\n        <jobref name="status" group="web">\n          <arg line="-dir ${option.dir}"/>\n        </jobref>\n      </command>\n    </sequence>\n   </job>\n</joblist>\n')])])]),n("p",[e._v("Note that we don't define a "),n("code",[e._v("<nodefilters>")]),e._v(" or "),n("code",[e._v("<dispatch>")]),e._v(" section for Restart, because we\nonly want this sequence to execute "),n("strong",[e._v("once")]),e._v(', on the server node. The Job\nreferences will each be called once, and the "start", "stop" and "status" Jobs will\neach be dispatched to the nodes they define.')]),e._v(" "),n("p",[e._v("Saving the XML definitions files located on the Rundeck server,\none can load them using the "),n("router-link",{attrs:{to:"/manpages/man1/"}},[e._v("rd-jobs")]),e._v(" command.")],1),e._v(" "),n("p",[e._v("Run the "),n("code",[e._v("rd-jobs load")]),e._v(" command for each job definition file:")]),e._v(" "),n("div",{staticClass:"language-{.bash} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("rd-jobs load -p anvils -f start.xml\nrd-jobs load -p anvils -f stop.xml\nrd-jobs load -p anvils -f status.xml\nrd-jobs load -p anvils -f restart.xml\n")])])]),n("p",[e._v("The "),n("code",[e._v("rd-jobs list")]),e._v(" command queries Rundeck and prints out the list of\ndefined jobs:")]),e._v(" "),n("div",{staticClass:"language-{.bash} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("rd-jobs list -p anvils\n")])])]),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Found 3 jobs:\n- Restart - 'the web restart procedure'\n- start - 'the web start procedure'\n- status - 'the web status procedure'\n- stop - 'the web stop procedure'\n")])])]),n("p",[e._v('Of course, the jobs can be viewed inside the Rundeck graphical console by going to\nthe Jobs page. Clicking the "Restart" job name and clicking the "Definition" tab reveals job detail.')]),e._v(" "),n("p",[n("img",{attrs:{src:"/figures/fig0607.png",alt:"Anvils Restart job"}})]),e._v(" "),n("p",[e._v('You will see the composition of the "Restart" job as a workflow\ncalling the jobs: stop, start, status. The "Restart" job passes the\nthe '),n("code",[e._v("-dir")]),e._v(" option to all the jobs and the\n"),n("code",[e._v("-method")]),e._v(" option value to the stop Job.")]),e._v(" "),n("h2",{attrs:{id:"running-the-job"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#running-the-job","aria-hidden":"true"}},[e._v("#")]),e._v(" Running the job")]),e._v(" "),n("h3",{attrs:{id:"run-using-the-gui"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#run-using-the-gui","aria-hidden":"true"}},[e._v("#")]),e._v(" Run using the GUI")]),e._v(" "),n("p",[e._v('The Jobs can be run from the Rundeck graphical console by going to the\n"Jobs" page. From there, navigate to the "web" job group to\ndisplay the three stored Jobs.')]),e._v(" "),n("p",[e._v('Clicking the "Run" button for the Restart job, will display the\noptions selection page. The menu for the "method" option displays the\ntwo choices: "normal" and "force". No other choices can be made, nor a\ntextfield for free form entry, because the "method" option was defined\nwith the restriction "enforced from allowed values".')]),e._v(" "),n("p",[n("img",{attrs:{src:"/figures/fig0608.png",alt:"Restart run page"}})]),e._v(" "),n("h3",{attrs:{id:"job-run-with-the-cli"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#job-run-with-the-cli","aria-hidden":"true"}},[e._v("#")]),e._v(" Job run with the CLI")]),e._v(" "),n("p",[e._v("The jobs can also be started from the command line using the\n"),n("router-link",{attrs:{to:"/manpages/man1/"}},[e._v("run")]),e._v('\nshell tool. The job group and name are specified\nusing the "-j" parameter. Any options the Job supports are supplied\nafter the "--" (double dash) parameter. (The "-p" parameter specifies the project,\nbut it can be left out if there is only one project available.)')],1),e._v(" "),n("p",[e._v('Run Restart specifying the method, "normal":')]),e._v(" "),n("div",{staticClass:"language-{.bash} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('run -j "web/Restart" -p anvils -- -method normal\n')])])]),n("p",[e._v('Run Restart specifying the method, "force":')]),e._v(" "),n("div",{staticClass:"language-{.bash} extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('run -j "web/Restart" -p anvils -- -method force\n')])])])])},[],!1,null,null,null);t.default=o.exports}}]);